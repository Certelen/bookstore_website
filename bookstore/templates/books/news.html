{% extends 'base.html' %}
{% load thumbnail %}
{% load static %}
{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'books:index' %}">Главная</a></li>
        <li class="breadcrumb-item active" aria-current="page">Новинки</li>
    </ol>
</nav>
<div class="row">
    <div class="col-12 background-after" style="min-height: 800px; height: unset;">
        <div class="row">
            <div class="col-12 col-lg-3">
                <button class="mobile-filters-button btn btn-light w-100 mb-3" type="button" data-bs-toggle="collapse"
                    data-bs-target="#filters" aria-expanded="false" aria-controls="filters">
                    <span>Фильтры</span>
                </button>
                <form id="filters" class="accordion collapse navbar-collapse mobile-filters" method="post"
                    action="{% url 'books:news' %}">
                    {% csrf_token %}
                    <div class="accordion accordion_collapse w-100 mb-3 mobile-filters" id="filters"
                        style="border-radius: 10px; overflow: hidden;">
                        <div class="accordion-item">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                <span>Жанры</span>
                            </button>
                            <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne"
                                data-bs-parent="#accordionExample">
                                <div class="accordion-body"
                                    style="max-height: 200px; overflow: scroll;background-color: #BAB2B5;">
                                    {% for genre in genres %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="{{ genre.id }}"
                                            id="flexCheckDefault" name="genres" {% if genre.id in filter_dict.genres %}
                                            checked {% endif %}>
                                        <label class="form-check-label" for="flexCheckDefault">
                                            {{ genre.name }}
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                <span>Цена</span>
                            </button>
                            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                                data-bs-parent="#accordionExample">
                                <div class="accordion-body" style="background-color: #BAB2B5;">
                                    <div class="d-flex justify-content-between">
                                        <input type="number" class="form-control text-white me-2" id="PriceMin"
                                            name="pricemin" placeholder="От" value="{{ filter_dict.pricemin }}">
                                        <input type="number" class="form-control text-white ms-2" id="PriceMax"
                                            name="pricemax" placeholder="До" value="{{ filter_dict.pricemax }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                <span>Дата выхода</span>
                            </button>
                            <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree"
                                data-bs-parent="#accordionExample">
                                <div class="accordion-body" style="background-color: #BAB2B5;">
                                    <div class="d-flex justify-content-between">
                                        <input type="text" class="form-control text-white me-2" id="DateMin"
                                            name="datemin" placeholder="Начиная с" onfocus="(this.type='date')"
                                            onblur="if(this.value==''){this.type='text'}"
                                            value="{{ filter_dict.datemin }}">
                                        <input type="text" class="form-control text-white me-2" id="DateMax"
                                            name="datemax" placeholder="Заканчивая до" onfocus="(this.type='date')"
                                            onblur="if(this.value==''){this.type='text'}"
                                            value="{{ filter_dict.datemax }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-light mb-2 text-light w-100"
                        style="background-color: #123C69;">Применить</button>
                    <button type="reset" class="btn btn-light text-light w-100 mb-4"
                        style="background-color: #AC3B61;">Сбросить</button>
                    <input id="sort_input" name="sort" value="{{ filter_dict.sort }}" hidden>
                </form>
            </div>
            <div class="col-12 offset-0 col-lg-9">
                <button class="mobile-filters-button btn btn-light w-100 mb-3" type="button" data-bs-toggle="collapse"
                    data-bs-target="#sort_links" aria-expanded="false" aria-controls="sort_links">
                    <span>Сортировка</span>
                </button>
                <div id="sort_links"
                    class="accordion collapse navbar-collapse justify-content-between px-3 mb-4 py-1 rounded-2 sort_links"
                    style="background-color: #BAB2B5;">
                    <a id="{{ buying }}" class="sort" name="buying" href="#"><span>Популярнее</span></a>
                    <a id="{{ min_price }}" class="sort" name="min_price" href="#"><span>Дороже</span></a>
                    <a id="{{ price }}" class="sort" name="price" href="#"><span>Дешевле</span></a>
                    <a id="{{ min_created }}" class="sort" name="min_created" href="#"><span>Позже</span></a>
                    <a id="{{ created }}" class="sort" name="created" href="#"><span>Раньше</span></a>
                </div>
                <div class="row">
                    {% for book in page_obj %}
                    <div class="col-6 col-lg-3 mb-3">
                        <a class="card" href="{% url 'books:book' book.id %}">
                            {% include 'dynamic_forms/favorite.html' %}
                            <div class="carousel-img">
                                {% thumbnail book.main_image "221x240" crop="center" upscale=True as book_main_image %}
                                <img src="{{ book_main_image.url }}" class="card-img-top" alt="...">
                                {% endthumbnail %}
                            </div>
                            <div class="card-body pt-1 pe-1 ps-1 pb-0 justify-content-between d-flex flex-column">
                                <span class="card-title mb-0 text-center"><b>{{ book.name }}</b></span>
                                <span class="card-text text-center">{{ book.author }}</span>
                                <div class="d-flex justify-content-between w-100">
                                    <div class="d-flex">
                                        <span class="ms-1" style="color:#FFFFFF">{{ book.price }} ₽</span>
                                    </div>
                                    <div class="d-flex">
                                        <span class="rating-result">★</span>
                                        <span class="rating-num">{{ book.score }}</span>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    // Клик по сотрировке отправляет форму
    $(function () {
        $('.sort').click(function () {
            sort_name = $(this).attr('name')
            $('#sort_input').attr('value', sort_name)
            $('#filters').submit()
        });
    });
</script>
{% endblock %}